<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>dual.Infodose Chat Cinematogr√°fico ‚Äî v2 (cristalizar + painel toggle)</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&amp;display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-dark: linear-gradient(to bottom,#000,#1a1a1a);
      --text-dark:#fff; --primary:#111; --secondary:#5e5c5e;
      --accent:#0ff; --fast:0.4s; --med:0.8s; --slow:1.8s;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;min-height:100vh}
    body{
      padding:20px;background:var(--bg-dark);color:var(--text-dark);
      font-family:'Montserrat',sans-serif;overflow:hidden;display:flex;flex-direction:column;align-items:center;
    }
    #particles-js{position:absolute;inset:0;z-index:0}
    .svg-container{position:absolute;top:35%;left:50%;transform:translate(-50%,-50%);width:160px;height:160px;z-index:1}
    .svg-container object{width:100%;height:100%}

    .top-info {
      position: fixed; top: 18px; left: 20px; z-index: 3;
      background: rgba(0,0,0,0.35); padding: 8px 12px; border-radius: 12px; font-size: 0.9em;
      backdrop-filter: blur(6px);
    }

    .response-container{
      position:fixed; left:20px; right:20px; bottom:160px;
      padding:12px;background:rgba(0,0,0,0.4);backdrop-filter:blur(10px);
      border-radius:20px; max-height:calc(100vh - 220px); overflow-y:auto; -webkit-overflow-scrolling:touch; z-index:1;
    }
    .page{display:none; opacity:0; transition:opacity var(--med) ease-in-out}
    .page.active{display:block; opacity:1}
    .page.initial{text-align:center;font-size:1.1em}
    .response-controls{display:flex;justify-content:space-between;align-items:center;margin-top:15px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.2)}
    .control-buttons{display:flex;gap:10px;align-items:center}
    .control-btn{background:rgba(255,255,255,0.05);padding:6px;border-radius:6px;cursor:pointer;transition:background var(--fast);display:flex;gap:6px;border:none;outline:none}
    .control-btn:hover{background:rgba(255,255,255,0.12)}
    .control-btn svg{stroke:rgba(255,255,255,0.5);fill:none}
    .toggle-button svg{color:#fff;stroke:rgba(255,255,255,0.3);fill:none}
    .toggle-button svg circle:nth-child(2){fill: currentColor}
    .toggle-button.active svg{color:#0f0}
    .pagination{display:flex;align-items:center;gap:10px}
    .pagination button{background:none;border:none;font-size:1.2em;color:#6fe4fb;cursor:pointer;transition:transform var(--fast)}
    .pagination button:hover{transform:scale(1.2)}
    .response-block{
      margin:1rem 0;padding:1.2rem;border-radius:12px;
      animation:fadeIn var(--slow) ease forwards; transition:box-shadow var(--fast),transform var(--fast);
      line-height:1.5;position:relative;cursor:pointer;overflow:hidden;animation:pulse 6s infinite ease-in-out;
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25));
      border: 1px solid rgba(255,255,255,0.03);
    }
    .response-block h3{margin-bottom:12px}
    .response-block:hover{box-shadow:0 0 15px rgba(0,255,255,0.12)}
    .response-block .meta { position:absolute; top:8px; right:8px; display:flex; gap:6px; }
    .crystal-btn {
      background: rgba(0,0,0,0.25); border-radius:6px; padding:6px; cursor:pointer; border:none; color:var(--accent);
    }
    .response-block.clicked{animation:clickPulse var(--med) ease-out}
    .response-block.expanded{transform:scale(1.03); background:rgba(0,0,0,0.6); z-index:2}
    .intro{background:linear-gradient(135deg,rgba(0,255,255,0.08),rgba(0,100,100,0.04));border-left:4px solid #0ff}
    .middle{background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(50,50,50,0.06));border-left:4px solid rgba(255,255,255,0.2)}
    .ending{background:linear-gradient(135deg,rgba(255,0,255,0.06),rgba(100,0,100,0.04));border-left:4px solid #f0f}
    .footer-text{margin-top:12px;font-size:0.8em;text-align:center;font-style:italic}

    .input-container{position:fixed;left:20px;right:20px;bottom:90px;display:flex;gap:10px;z-index:2;max-width:calc(100% - 40px)}
    .input-container input{flex:1;padding:10px;border:none;border-radius:20px;background:rgba(255,255,255,0.1);color:inherit;outline:none;font-size:16px;transition:background var(--fast)}
    .input-container input:focus{background:rgba(255,255,255,0.2)}
    .input-container button{width:60px;height:60px;border:none;border-radius:50%;background:linear-gradient(45deg,var(--primary),var(--secondary));color:#fff;font-size:1.5em;cursor:pointer;display:flex;justify-content:center;align-items:center;animation:pulse 2s infinite ease-in-out;transition:transform var(--fast)}
    .input-container button:hover{transform:scale(1.1)}

    /* Settings + Toggle Panel + Crystal Modal */
    .modal, .panel { position: fixed; inset: 0; display: none; z-index: 9998; justify-content:center; align-items:center; }
    .modal.active, .panel.active { display:flex }
    .box {
      background:#1a1a1a;padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);
      width:90%;max-width:520px;box-shadow:0 8px 40px rgba(0,0,0,0.6); color:#fff;
    }
    .box h3{color:var(--accent);margin-bottom:8px}
    .row{display:flex;gap:10px;align-items:center}
    .col{display:flex;flex-direction:column;gap:8px}
    .input-group label{font-size:0.85em;color:#aaa;margin-left:4px}
    .input-group input[type="text"], .input-group input[type="password"], .input-group input[type="file"]{
      width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.5);color:#fff;outline:none;
    }
    .settings-actions{display:flex;gap:10px;margin-top:12px}
    .btn{padding:10px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-prim{background:var(--accent);color:#000}
    .btn-sec{background:rgba(255,255,255,0.08);color:#fff}
    .small {font-size:0.85em;color:#bbb}

    .crystal-list { max-height:300px; overflow:auto; display:flex; flex-direction:column; gap:8px }
    .crystal-item { background: rgba(255,255,255,0.02); padding:8px; border-radius:8px; display:flex; justify-content:space-between; gap:8px; align-items:flex-start }
    .crystal-item .actions { display:flex; gap:6px }

    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes clickPulse{0%,100%{opacity:1}50%{opacity:0.8}}
    /* responsive tweaks */
    @media (max-width:640px){
      .box{max-width:92%}
      .svg-container{width:120px;height:120px}
    }
  </style>
</head>
<body>
  <div id="particles-js"><canvas class="particles-js-canvas-el"></canvas></div>

  <div class="svg-container">
    <object data="3D_logo_Dual_Infodose_9.svg" type="image/svg+xml"></object>
  </div>

  <div class="top-info" id="topInfo">
    <span id="displayUser">User: ‚Äî</span> ¬∑ <span id="displayInfodose">Infodose: ‚Äî</span>
  </div>

  <div class="response-container" id="response">
    <div class="page initial active">
      <strong>Clique no ‚óâ e diga ‚ÄúOi, Dual‚Äù.</strong><br>
      <em>Sempre √∫nico. Sempre seu.</em>
    </div>

    <div class="response-controls">
      <div class="control-buttons">
        <button class="control-btn copy-button" title="Copiar tudo">
          <svg viewBox="0 0 24 24" width="20"><circle cx="12" cy="12" r="10"></circle><rect x="6" y="6" width="12" height="12"></rect></svg>
        </button>
        <button class="control-btn paste-button" title="Colar">
          <svg viewBox="0 0 24 24" width="20"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="4" x2="12" y2="20"></line></svg>
        </button>

        <!-- Toggle abre painel em vez de s√≥ alternar -->
        <button id="toggleBtn" class="control-btn toggle-button" title="Painel Infodose">
          <svg viewBox="0 0 24 24" width="20" height="20"><circle cx="12" cy="12" r="10" stroke-width="2"></circle><circle cx="12" cy="12" r="3"></circle></svg>
        </button>

        <button id="crystalBtn" class="control-btn" title="Cristalizados">
          <svg viewBox="0 0 24 24" width="20" height="20"><path d="M12 2l2.9 6.3L21 10l-5 3.6L17.8 21 12 17.7 6.2 21 7 13.6 2 10l6.1-1.7L12 2z"></path></svg>
        </button>

        <button id="settingsBtn" class="control-btn" title="Configura√ß√µes">
          <svg viewBox="0 0 24 24" width="20" height="20"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
      </div>

      <div class="pagination">
        <button data-action="prev">‚üµ</button>
        <span id="pageIndicator">1 / 1</span>
        <button data-action="next">‚ü∂</button>
      </div>
    </div>
  </div>

  <div class="input-container">
    <input id="userInput" type="text" placeholder="Diga: 'oi, Dual'...">
    <button id="sendBtn" title="Enviar">‚û§</button>
    <button id="voiceBtn" title="Falar">
      <object data="Reset_buttom_Dual-Infodose.svg" type="image/svg+xml" width="36" height="36" style="pointer-events: none;"></object>
    </button>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="box">
      <h3>Configura√ß√£o Neural</h3>
      <div class="col">
        <div class="input-group">
          <label>OpenRouter API Key (SK)</label>
          <input type="password" id="apiKeyInput" placeholder="sk-or-..." autocomplete="off">
        </div>
        <div class="input-group">
          <label>Modelo AI</label>
          <input type="text" id="modelInput" placeholder="ex: meta-llama/llama-4-maverick:free">
        </div>
        <div class="settings-actions">
          <button id="cancelSettings" class="btn btn-sec">Cancelar</button>
          <button id="saveSettings" class="btn btn-prim">Salvar Conex√£o</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toggle Panel (painel do bot√£o toggle) -->
  <div id="togglePanel" class="panel">
    <div class="box">
      <h3>Painel Infodose</h3>

      <div class="row">
        <div style="flex:1" class="col">
          <label class="small">Usu√°rio</label>
          <input type="text" id="userNameInput" placeholder="Seu nome..." />
        </div>
        <div style="flex:1" class="col">
          <label class="small">Nome da Infodose</label>
          <input type="text" id="infodoseNameInput" placeholder="Ex: World System ‚Äî Alpha" />
        </div>
      </div>

      <div style="margin-top:10px" class="col">
        <label class="small">Treinamento (World System) ‚Äî Upload / Export</label>
        <input type="file" id="trainingUpload" accept=".txt" />
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="importTrainingBtn" class="btn btn-sec">Importar (ler)</button>
          <button id="exportTrainingBtn" class="btn btn-prim">Exportar treino</button>
        </div>
        <div id="trainingFileName" class="small" style="margin-top:6px;color:#9bd">Nenhum arquivo carregado</div>
      </div>

      <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
        <label class="small" style="flex:1">Infodose ativa</label>
        <input type="checkbox" id="assistantActiveCheckbox" />
        <label class="small" style="flex:1">Treinamento ativo</label>
        <input type="checkbox" id="trainingActiveCheckbox" />
      </div>

      <div style="margin-top:12px; display:flex; gap:8px;">
        <button id="savePanelBtn" class="btn btn-prim">Salvar Painel</button>
        <button id="closePanelBtn" class="btn btn-sec">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Crystal modal (lista de cristalizados) -->
  <div id="crystalModal" class="modal">
    <div class="box">
      <h3>Cristalizados</h3>
      <div class="row" style="margin-bottom:8px">
        <button id="exportAllCrystal" class="btn btn-prim">Exportar todos</button>
        <button id="clearAllCrystal" class="btn btn-sec">Limpar tudo</button>
      </div>
      <div class="crystal-list" id="crystalList"></div>
      <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
        <button id="closeCrystal" class="btn btn-sec">Fechar</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script>
    /* ---------- Constantes iniciais ---------- */
    const TRAINING_FILE_FALLBACK = 'Super_Treinamento_Universal_Dual_Infodose_v1-28.txt';
    const API_ENDPOINT = 'https://openrouter.ai/api/v1/chat/completions';
    const TEMPERATURE = 0.2;

    // estado
    let training = '';
    let trainingFileName = '';
    let assistantEnabled = false;
    let trainingActive = true; // se false, n√£o inclui 'system' no conversation
    let conversation = [];
    let pages = [], currentPage = 0, autoAdvance = true;

    // configs persistidas
    let apiKey = localStorage.getItem('di_apiKey') || '';
    let modelName = localStorage.getItem('di_modelName') || 'meta-llama/llama-4-maverick:free';
    let userName = localStorage.getItem('di_userName') || '';
    let infodoseName = localStorage.getItem('di_infodoseName') || '';
    const CRYSTAL_KEY = 'di_cristalizados';

    const createEl = (tag, cls, html) => { const e = document.createElement(tag); if (cls) e.className = cls; if (html) e.innerHTML = html; return e; };
    const splitBlocks = text => {
      if (!text || !text.trim()) return [['Sem conte√∫do de treinamento.','','']];
      let paras = text.split(/\n\s*\n/).filter(p=>p.trim());
      if (paras.length % 3 !== 0) {
        const sens = paras.join(' ').match(/[^\.!\?]+[\.!\?]+/g) || [paras.join(' ')];
        paras = sens.map(s=>s.trim());
      }
      const groups = [];
      for (let i=0;i<paras.length;i+=3) groups.push(paras.slice(i,i+3));
      return groups;
    };

    // simples TTS
    const speakText = (txt, onend)=> {
      if (!txt) { if (onend) onend(); return; }
      const u = new SpeechSynthesisUtterance(txt);
      u.lang = 'pt-BR'; u.rate = 0.99; u.pitch = 1.1; u.volume = 1;
      if (window._vozes) u.voice = window._vozes.find(v=>v.lang==='pt-BR') || window._vozes[0];
      if (onend) u.onend = onend;
      speechSynthesis.speak(u);
    };

    const updateTopInfo = () => {
      document.getElementById('displayUser').innerText = 'User: ' + (userName || '‚Äî');
      document.getElementById('displayInfodose').innerText = 'Infodose: ' + (infodoseName || '‚Äî');
    };

    const updateToggleUI = () => {
      document.getElementById('toggleBtn').classList.toggle('active', assistantEnabled);
      document.getElementById('assistantActiveCheckbox').checked = !!assistantEnabled;
      document.getElementById('trainingActiveCheckbox').checked = !!trainingActive;
    };

    /* ---------- Carregamento inicial (treinamento: localStorage -> arquivo) ---------- */
    async function loadInitialTraining() {
      // 1) prefer√™ncia local
      const localTraining = localStorage.getItem('di_trainingText');
      const localFileName = localStorage.getItem('di_trainingFileName') || '';
      if (localTraining) {
        training = localTraining;
        trainingFileName = localFileName;
        document.getElementById('trainingFileName').innerText = localFileName || 'treinamento (local)';
        return;
      }
      // 2) tentativa fetch do arquivo fallback
      try {
        const r = await fetch(TRAINING_FILE_FALLBACK);
        if (r.ok) {
          training = await r.text();
          trainingFileName = TRAINING_FILE_FALLBACK;
          document.getElementById('trainingFileName').innerText = TRAINING_FILE_FALLBACK;
        }
      } catch (e) { /* silent */ }
    }

    /* ---------- Render paginado com bot√µes cristalizar ---------- */
    const renderPaginatedResponse = text => {
      speechSynthesis.cancel();
      autoAdvance = true;
      const respEl = document.getElementById('response');
      respEl.querySelectorAll('.page:not(.initial)').forEach(p=>p.remove());
      pages = [];
      const groups = splitBlocks(text);
      const controls = respEl.querySelector('.response-controls');
      const titles = ['üéÅ Recompensa Inicial','üëÅÔ∏è Explora√ß√£o e Curiosidade','‚ö° Antecipa√ß√£o Vibracional'];

      groups.forEach((tris, gi) => {
        const page = createEl('div', gi===0?'page active':'page');
        tris.forEach((body, j) => {
          const cls = j===0?'intro': j===1?'middle':'ending';
          const b = createEl('div','response-block '+cls,`
            <h3>${titles[j]}</h3><p>${body}</p>
          `);
          // meta area: cristalizar + timestamp
          const meta = createEl('div','meta');
          const crystalBtn = createEl('button','crystal-btn','‚ú∂');
          crystalBtn.title = 'Cristalizar essa mensagem';
          crystalBtn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            cristalizar({ title: titles[j], content: body });
            crystalBtn.innerText = '‚úì';
            setTimeout(()=> crystalBtn.innerText = '‚ú∂', 1200);
          });
          meta.appendChild(crystalBtn);
          b.appendChild(meta);

          b.dataset.state = '';
          b.addEventListener('click', () => {
            if (!b.dataset.state) {
              speechSynthesis.cancel();
              speakText(body);
              b.classList.add('clicked');
              b.dataset.state = 'spoken';
            } else {
              b.classList.add('expanded');
              b.dataset.state = '';
              // se habilitar assistant ao clicar em bloco, insere training (apenas se trainingActive)
              if (!assistantEnabled) {
                assistantEnabled = true;
                localStorage.setItem('di_assistantEnabled','1');
                if (training && trainingActive) conversation.unshift({ role:'system', content: training });
                updateToggleUI();
              }
              const blockText = `${titles[j]}\n\n${body}`;
              showLoading('Pulso em Expans√£o...');
              speechSynthesis.cancel();
              speakText('Pulso em Expans√£o...');
              conversation.push({ role:'user', content: blockText });
              callAI();
            }
          });
          b.addEventListener('animationend', e => { if (e.animationName==='clickPulse') b.classList.remove('clicked'); });
          page.appendChild(b);
        });
        page.appendChild(createEl('p','footer-text',`<em>Do seu jeito. <strong>Sempre</strong> √∫nico. <strong>Sempre</strong> seu.</em>`));
        respEl.insertBefore(page, controls);
        pages.push(page);
      });

      currentPage = 0;
      document.getElementById('pageIndicator').textContent = `1 / ${pages.length}`;
      speakPage(0);
    };

    const speakPage = i => {
      const page = pages[i];
      if (!page) return;
      const body = Array.from(page.querySelectorAll('.response-block p')).map(p=>p.innerText).join(' ');
      speakText(body, () => {
        if (!autoAdvance) return;
        if (i < pages.length - 1) {
          changePage(1);
          speakPage(i+1);
        } else {
          speakText('Do seu jeito, sempre √∫nico, sempre seu.');
        }
      });
    };
    const changePage = offset => {
      const np = currentPage + offset;
      if (np<0||np>=pages.length) return;
      pages[currentPage].classList.remove('active');
      pages[np].classList.add('active');
      currentPage = np;
      document.getElementById('pageIndicator').textContent = `${currentPage+1} / ${pages.length}`;
    };

    /* ---------- showLoading ---------- */
    const showLoading = msg => {
      const respEl = document.getElementById('response');
      const controls = respEl.querySelector('.response-controls');
      respEl.querySelectorAll('.page:not(.initial)').forEach(p=>p.remove());
      const page = createEl('div','page active');
      page.appendChild(createEl('p','footer-text',msg));
      respEl.insertBefore(page, controls);
      pages = [page];
      currentPage = 0;
      document.getElementById('pageIndicator').textContent = '‚Ä¶';
    };

    /* ---------- Chamada AI ---------- */
    async function callAI() {
      if (!apiKey) {
        alert('Por favor, configure sua API Key no bot√£o de configura√ß√µes.');
        document.getElementById('settingsModal').classList.add('active');
        return;
      }

      // monta messages: se trainingActive & assistantEnabled inclui training como system
      const bodyObj = { model: modelName, messages: conversation.slice(), temperature: TEMPERATURE };
      const messagesToSend = [];
      if (assistantEnabled && trainingActive && training) messagesToSend.push({ role:'system', content: training });
      // concat conversas (usa conversation sem duplicar system se j√° tiver)
      conversation.forEach(m => {
        // evita duplicar system entries no conversation
        if (m.role === 'system') return;
        messagesToSend.push(m);
      });
      bodyObj.messages = messagesToSend;

      try {
        const resp = await fetch(API_ENDPOINT, {
          method:'POST',
          headers:{ 'Authorization':`Bearer ${apiKey}`, 'Content-Type':'application/json' },
          body: JSON.stringify(bodyObj)
        });
        if (!resp.ok) throw new Error('Erro API: ' + resp.status);
        const data = await resp.json();
        const answer = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content)
          ? data.choices[0].message.content.trim()
          : (data.result || 'Resposta vazia');
        conversation.push({ role:'assistant', content: answer });
        renderPaginatedResponse(answer);
      } catch (err) {
        console.error(err);
        const errorMsg = 'O pulso oscilou (Erro de Conex√£o ou Key inv√°lida). Verifique as configura√ß√µes.';
        conversation.push({ role:'assistant', content: errorMsg });
        renderPaginatedResponse(errorMsg);
      }
    }

    /* ---------- Envio de mensagem ---------- */
    async function sendMessage(){
      const respEl = document.getElementById('response');
      const initPage = respEl.querySelector('.page.initial');
      if (initPage) initPage.remove();

      const input = document.getElementById('userInput');
      const raw = input.value.trim();
      if (!raw) return;
      input.value = '';

      speechSynthesis.cancel();
      speakText('');

      // reconhecimento simples de entidades
      const txt = raw.toLowerCase();
      if (txt === 'oi dual' || txt === 'oi, dual') {
        assistantEnabled = true;
        localStorage.setItem('di_assistantEnabled','1');
        showLoading('Dual Infodose ativa. Pulso enviado...');
        if (training && trainingActive) conversation.unshift({ role:'system', content: training });
        updateToggleUI();
      } else {
        showLoading('‚ö°Pulso enviado...Recebendo Inten√ß√£o‚Ä¶');
      }

      conversation.push({ role:'user', content: raw });
      callAI();
    }

    /* ---------- Cristalizar (salvar mensagem) ---------- */
    function cristalizar({ title, content }) {
      const list = JSON.parse(localStorage.getItem(CRYSTAL_KEY) || '[]');
      const item = {
        id: Date.now(),
        title: title,
        content: content,
        user: userName || '‚Äî',
        infodose: infodoseName || '‚Äî',
        at: new Date().toISOString()
      };
      list.unshift(item);
      localStorage.setItem(CRYSTAL_KEY, JSON.stringify(list));
      refreshCrystalList();
    }

    function refreshCrystalList() {
      const list = JSON.parse(localStorage.getItem(CRYSTAL_KEY) || '[]');
      const el = document.getElementById('crystalList');
      el.innerHTML = '';
      if (!list.length) {
        el.innerHTML = '<div class="small">Nenhum cristalizado ainda.</div>';
        return;
      }
      list.forEach(it => {
        const row = createEl('div','crystal-item');
        const left = createEl('div','','<strong>'+ (it.title||'‚Äî') +'</strong><div class="small">'+(it.infodose || '')+' ¬∑ '+(new Date(it.at)).toLocaleString()+'</div><div style="margin-top:6px">'+ (it.content.length>220 ? it.content.slice(0,220)+'...' : it.content) +'</div>');
        const actions = createEl('div','actions');
        const copyBtn = createEl('button','btn btn-sec','Copiar');
        copyBtn.addEventListener('click', ()=> { navigator.clipboard.writeText(it.content); });
        const exportBtn = createEl('button','btn btn-prim','Exportar');
        exportBtn.addEventListener('click', ()=> {
          const blob = new Blob([it.content], { type:'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = `cristal_${it.id}.txt`; a.click(); URL.revokeObjectURL(url);
        });
        const delBtn = createEl('button','btn btn-sec','Apagar');
        delBtn.addEventListener('click', () => {
          const arr = JSON.parse(localStorage.getItem(CRYSTAL_KEY) || '[]').filter(x => x.id !== it.id);
          localStorage.setItem(CRYSTAL_KEY, JSON.stringify(arr));
          refreshCrystalList();
        });
        actions.appendChild(copyBtn); actions.appendChild(exportBtn); actions.appendChild(delBtn);
        row.appendChild(left); row.appendChild(actions);
        el.appendChild(row);
      });
    }

    /* ---------- Eventos de UI: Settings / Toggle painel / Crystal ---------- */
    function setupSettings() {
      const modal = document.getElementById('settingsModal');
      const btn = document.getElementById('settingsBtn');
      const closeBtn = document.getElementById('cancelSettings');
      const saveBtn = document.getElementById('saveSettings');
      const keyInput = document.getElementById('apiKeyInput');
      const modelInput = document.getElementById('modelInput');

      btn.addEventListener('click', () => {
        keyInput.value = apiKey;
        modelInput.value = modelName;
        modal.classList.add('active');
      });
      const closeModal = () => modal.classList.remove('active');
      closeBtn.addEventListener('click', closeModal);
      saveBtn.addEventListener('click', () => {
        apiKey = keyInput.value.trim();
        modelName = modelInput.value.trim() || modelName;
        localStorage.setItem('di_apiKey', apiKey);
        localStorage.setItem('di_modelName', modelName);
        alert('Conex√£o Neural Salva.');
        closeModal();
      });
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    }

    function setupTogglePanel() {
      const panel = document.getElementById('togglePanel');
      const btn = document.getElementById('toggleBtn');
      const closeBtn = document.getElementById('closePanelBtn');
      const saveBtn = document.getElementById('savePanelBtn');
      const userInput = document.getElementById('userNameInput');
      const infodoseInput = document.getElementById('infodoseNameInput');
      const assistantChk = document.getElementById('assistantActiveCheckbox');
      const trainingChk = document.getElementById('trainingActiveCheckbox');
      const fileInput = document.getElementById('trainingUpload');
      const importBtn = document.getElementById('importTrainingBtn');
      const exportBtn = document.getElementById('exportTrainingBtn');
      const trainingNameEl = document.getElementById('trainingFileName');

      btn.addEventListener('click', () => {
        // preencher valores
        userInput.value = userName;
        infodoseInput.value = infodoseName;
        assistantChk.checked = !!assistantEnabled;
        trainingChk.checked = !!trainingActive;
        panel.classList.add('active');
      });
      closeBtn.addEventListener('click', ()=> panel.classList.remove('active'));
      saveBtn.addEventListener('click', () => {
        userName = userInput.value.trim();
        infodoseName = infodoseInput.value.trim();
        assistantEnabled = !!assistantChk.checked;
        trainingActive = !!trainingChk.checked;
        localStorage.setItem('di_userName', userName);
        localStorage.setItem('di_infodoseName', infodoseName);
        localStorage.setItem('di_assistantEnabled', assistantEnabled ? '1' : '0');
        localStorage.setItem('di_trainingActive', trainingActive ? '1' : '0');
        updateTopInfo();
        updateToggleUI();
        panel.classList.remove('active');
      });

      // file upload listener (preview)
      fileInput.addEventListener('change', (e) => {
        const f = e.target.files[0];
        if (!f) return;
        trainingFileName = f.name;
      });

      importBtn.addEventListener('click', ()=> {
        const f = fileInput.files[0];
        if (!f) { alert('Escolha um arquivo .txt para importar.'); return; }
        const r = new FileReader();
        r.onload = (ev) => {
          training = ev.target.result;
          trainingFileName = f.name || 'uploaded_training.txt';
          localStorage.setItem('di_trainingText', training);
          localStorage.setItem('di_trainingFileName', trainingFileName);
          document.getElementById('trainingFileName').innerText = trainingFileName;
          alert('Treinamento importado e salvo localmente.');
        };
        r.readAsText(f,'utf-8');
      });

      exportBtn.addEventListener('click', ()=> {
        if (!training) { alert('Nenhum treinamento presente para exportar.'); return; }
        const blob = new Blob([training], { type:'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = trainingFileName || 'training_export.txt'; a.click(); URL.revokeObjectURL(url);
      });
    }

    function setupCrystalModal() {
      const btn = document.getElementById('crystalBtn');
      const modal = document.getElementById('crystalModal');
      const close = document.getElementById('closeCrystal');
      const exportAll = document.getElementById('exportAllCrystal');
      const clearAll = document.getElementById('clearAllCrystal');

      btn.addEventListener('click', () => {
        refreshCrystalList();
        modal.classList.add('active');
      });
      close.addEventListener('click', ()=> modal.classList.remove('active'));
      exportAll.addEventListener('click', ()=> {
        const list = JSON.parse(localStorage.getItem(CRYSTAL_KEY) || '[]');
        if (!list.length) { alert('Nada para exportar.'); return; }
        const content = list.map(it => `--- ${it.title} ¬∑ ${it.at} ¬∑ ${it.infodose}\n\n${it.content}\n\n`).join('\n');
        const blob = new Blob([content], { type:'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `cristalizados_${Date.now()}.txt`; a.click(); URL.revokeObjectURL(url);
      });
      clearAll.addEventListener('click', ()=> {
        if (!confirm('Limpar todos os cristalizados?')) return;
        localStorage.removeItem(CRYSTAL_KEY);
        refreshCrystalList();
      });
      document.getElementById('crystalModal').addEventListener('click', (e)=> { if (e.target === document.getElementById('crystalModal')) document.getElementById('crystalModal').classList.remove('active'); });
    }

    /* ---------- Clipboard + other small UI ---------- */
    document.addEventListener('DOMContentLoaded', async () => {
      // voice voices
      speechSynthesis.onvoiceschanged = () => { window._vozes = speechSynthesis.getVoices(); };

      // carregar configs
      apiKey = localStorage.getItem('di_apiKey') || apiKey;
      modelName = localStorage.getItem('di_modelName') || modelName;
      userName = localStorage.getItem('di_userName') || userName;
      infodoseName = localStorage.getItem('di_infodoseName') || infodoseName;
      assistantEnabled = (localStorage.getItem('di_assistantEnabled') === '1') || assistantEnabled;
      trainingActive = (localStorage.getItem('di_trainingActive') === '0') ? false : trainingActive;

      await loadInitialTraining();
      updateTopInfo();
      updateToggleUI();
      setupSettings();
      setupTogglePanel();
      setupCrystalModal();

      particlesJS('particles-js',{
        particles:{ number:{value:40},color:{value:['#0ff','#f0f']}, shape:{type:'circle'},opacity:{value:0.4},size:{value:2.4}, move:{enable:true,speed:1.5} }, retina_detect:true
      });

      // eventos b√°sicos
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('userInput').addEventListener('keypress', e => { if (e.key==='Enter') sendMessage(); });
      document.querySelector('[data-action="prev"]').addEventListener('click', () => changePage(-1));
      document.querySelector('[data-action="next"]').addEventListener('click', () => changePage(1));

      document.querySelector('.copy-button').addEventListener('click', () => {
        const pages = Array.from(document.querySelectorAll('.response-container .page'));
        const fullText = pages.map(p => p.innerText.trim()).join('\n\n');
        navigator.clipboard.writeText(fullText);
      });

      document.querySelector('.paste-button').addEventListener('click', async () => {
        try {
          const text = await navigator.clipboard.readText();
          document.getElementById('userInput').value = text;
        } catch (err) { console.error('Falha ao colar', err); }
      });

      // voice quick
      document.getElementById('voiceBtn').addEventListener('click', ()=>{
        const R = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
        R.lang='pt-BR'; R.start();
        R.onresult = e => {
          document.getElementById('userInput').value = e.results[0][0].transcript;
          sendMessage();
        };
      });
    });

  </script>
</body>
</html>