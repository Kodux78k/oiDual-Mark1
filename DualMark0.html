<!DOCTYPE html><html lang="pt-BR"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>dual.Infodose Chat Cinematogr√°fico</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&amp;display=swap" rel="stylesheet">
  
  <link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="apple-touch-icon" href="./icon-192.png">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log('Service Worker Registered'));
  }
</script>
  <style>
    :root {
      --bg-dark: linear-gradient(to bottom, #000, #1a1a1a);
      --text-dark: #fff;
      --primary: #111;
      --secondary: #5e5c5e;
      --accent: #0ff;
      --fast: 0.4s;
      --med: 0.8s;
      --slow: 1.8s;
    }
    * { box-sizing:border-box; margin:0; padding:0 }
    html, body {
      overflow: hidden; /* bloqueia scroll do background sempre */
    }
    body {
      padding:20px; background:var(--bg-dark); color:var(--text-dark);
      font-family:'Montserrat',sans-serif; min-height:100lvh; overflow:hidden;
      display:flex; flex-direction:column; align-items:center;
    }
    #particles-js { position:absolute; inset:0; z-index:0 }
    .svg-container {
      position:absolute; top:35%; left:50%;
      transform:translate(-50%,-50%);
      width:160px; height:160px; z-index:1;
    }
    .svg-container object { width:100%; height:100% }
    .response-container {
      position:fixed; left:20px; right:20px; bottom:160px;
      padding:12px; background:rgba(0,0,0,0.4); backdrop-filter:blur(10px);
      border-radius:20px; max-height:calc(100vh - 200px);
      overflow-y:auto; -webkit-overflow-scrolling:touch; z-index:1;
    }
    .page { display:none; opacity:0; transition:opacity var(--med) ease-in-out }
    .page.active { display:block; opacity:1 }
    .page.initial { text-align:center; font-size:1.1em }
    .response-controls {
      display:flex; justify-content:space-between; align-items:center;
      margin-top:15px; padding-top:10px;
      border-top:1px solid rgba(255,255,255,0.2);
    }
    .control-buttons { display:flex; gap:10px }
    .control-btn {
      background:rgba(255,255,255,0.05); padding:6px; border-radius:6px;
      cursor:pointer; transition:background var(--fast); display:flex; gap:6px; border: none; outline: none;
    }
    .control-btn:hover {
      background:rgba(255,255,255,0.15)
    }
    .control-btn svg {
      stroke:rgba(255,255,255,0.5); fill:none;
    }
    .toggle-button svg {
      color:#fff;
      stroke:rgba(255,255,255,0.3);
      fill:none;
    }
    .toggle-button svg circle:nth-child(2) {
      fill: currentColor;
    }
    .toggle-button.active svg {
      color:#0f0;
    }
    .toggle-button.active svg circle:nth-child(1) {
      stroke:#0f0;
    }
    .pagination { display:flex; align-items:center; gap:10px }
    .pagination button {
      background:none; border:none; font-size:1.2em;
      color:#6fe4fb; cursor:pointer; transition:transform var(--fast);
    }
    .pagination button:hover { transform:scale(1.2) }
    .response-block {
      margin:1rem 0; padding:1.2rem; border-radius:12px;
      animation:fadeIn var(--slow) ease forwards;
      transition:box-shadow var(--fast),transform var(--fast);
      line-height:1.5; position:relative; cursor:pointer; overflow:hidden;animation:pulse 6s infinite ease-in-out;
    }
    .response-block h3 { margin-bottom:12px }
    .response-block:hover { box-shadow:0 0 15px rgba(0,255,255,0.4) }
    .response-block.clicked { animation:clickPulse var(--med) ease-out }
    .response-block.expanded {
      transform:scale(1.03); background:rgba(0,0,0,0.6); z-index:2;
    }
    .intro {
      background:linear-gradient(135deg,rgba(0,255,255,0.2),rgba(0,100,100,0.1));
      border-left:4px solid #0ff;
    }
    .middle {
      background:linear-gradient(135deg,rgba(255,255,255,0.05),rgba(50,50,50,0.1));
      border-left:4px solid rgba(255,255,255,0.4);
    }
    .ending {
      background:linear-gradient(135deg,rgba(255,0,255,0.2),rgba(100,0,100,0.1));
      border-left:4px solid #f0f;
    }
    .footer-text {
      margin-top:12px; font-size:0.8em; text-align:center; font-style:italic;
    }
    .input-container {
      position:fixed; left:20px; right:20px; bottom:90px;
      display:flex; gap:10px; z-index:2; max-width:calc(100% - 40px);
    }
    .input-container input {
      flex:1; padding:10px; border:none; border-radius:20px;
      background:rgba(255,255,255,0.1); color:inherit; outline:none;
      font-size:16px; transition:background var(--fast);
    }
    .input-container input:focus { background:rgba(255,255,255,0.2) }
    .input-container button {
      width:60px; height:60px; border:none; border-radius:50%;
      background:linear-gradient(45deg,var(--primary),var(--secondary));
      color:#fff; font-size:1.5em; cursor:pointer;
      display:flex; justify-content:center; align-items:center;
      animation:pulse 2s infinite ease-in-out;
      transition:transform var(--fast);
    }
    .input-container button:hover { transform:scale(1.1) }

    /* Modal de Settings */
    .settings-modal {
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
      display: none; justify-content: center; align-items: center;
    }
    .settings-modal.active { display: flex; animation: fadeIn var(--fast) ease-out; }
    .settings-box {
      background: #1a1a1a; padding: 25px; border-radius: 15px;
      border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 400px;
      box-shadow: 0 0 20px rgba(0,255,255,0.1);
      display: flex; flex-direction: column; gap: 15px;
    }
    .settings-box h3 { text-align: center; color: var(--accent); margin-bottom: 10px; }
    .input-group { display: flex; flex-direction: column; gap: 5px; }
    .input-group label { font-size: 0.8em; color: #aaa; margin-left: 5px; }
    .input-group input {
      width: 100%; padding: 12px; background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;
      color: #fff; font-family: inherit; outline: none;
    }
    .input-group input:focus { border-color: var(--accent); }
    .settings-actions { display: flex; gap: 10px; margin-top: 10px; }
    .btn-save, .btn-cancel {
      flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
    }
    .btn-save { background: var(--accent); color: #000; }
    .btn-save:hover { box-shadow: 0 0 10px var(--accent); }
    .btn-cancel { background: rgba(255,255,255,0.1); color: #fff; }
    .btn-cancel:hover { background: rgba(255,255,255,0.2); }

    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @keyframes clickPulse{0%,100%{opacity:1}50%{opacity:0.8}}
  </style>
</head>
<body>
  <div id="particles-js"><canvas class="particles-js-canvas-el"></canvas></div>
  <div class="svg-container">
    <object data="3D_logo_Dual_Infodose_9.svg" type="image/svg+xml"></object>
  </div>

  <div class="response-container" id="response">
    <div class="page initial active">
      <strong>Clique no ‚óâ e diga ‚ÄúOi, Dual‚Äù.</strong><br>
      <em>Sempre √∫nico. Sempre seu.</em>
    </div>
    <div class="response-controls">
      <div class="control-buttons">
        <button class="control-btn copy-button" title="Copiar">
          <svg viewBox="0 0 24 24" width="20">
            <circle cx="12" cy="12" r="10"></circle>
            <rect x="6" y="6" width="12" height="12"></rect>
          </svg>
        </button>
        <button class="control-btn paste-button" title="Colar">
          <svg viewBox="0 0 24 24" width="20">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="4" x2="12" y2="20"></line>
          </svg>
        </button>
        <button id="toggleBtn" class="control-btn toggle-button" title="Ativar Infodose">
          <svg viewBox="0 0 24 24" width="20" height="20">
            <circle cx="12" cy="12" r="10" stroke-width="2"></circle>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
        <button id="settingsBtn" class="control-btn" title="Configura√ß√µes">
          <svg viewBox="0 0 24 24" width="20" height="20">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
        </button>
      </div>
      <div class="pagination">
        <button data-action="prev">‚üµ</button>
        <span id="pageIndicator">1 / 1</span>
        <button data-action="next">‚ü∂</button>
      </div>
    </div>
  </div>

  <div class="input-container">
    <input id="userInput" type="text" placeholder="Diga: 'oi, Dual'...">
    <button id="sendBtn" title="Enviar">‚û§</button>
    <button id="voiceBtn" title="Falar">
      <object data="Reset_buttom_Dual-Infodose.svg" type="image/svg+xml" width="36" height="36" style="pointer-events: none;"></object>
    </button>
  </div>

  <div id="settingsModal" class="settings-modal">
    <div class="settings-box">
      <h3>Configura√ß√£o Neural</h3>
      <div class="input-group">
        <label>OpenRouter API Key (SK)</label>
        <input type="password" id="apiKeyInput" placeholder="sk-or-v1-..." autocomplete="off">
      </div>
      <div class="input-group">
        <label>Modelo AI</label>
        <input type="text" id="modelInput" placeholder="ex: meta-llama/llama-3..." value="meta-llama/llama-4-maverick:free">
      </div>
      <div class="settings-actions">
        <button id="cancelSettings" class="btn-cancel">Cancelar</button>
        <button id="saveSettings" class="btn-save">Salvar Conex√£o</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script>
    const TRAINING_FILE = 'Super_Treinamento_Universal_Dual_Infodose_v1-28.txt';
    const API_ENDPOINT   = 'https://openrouter.ai/api/v1/chat/completions';
    const TEMPERATURE    = 0.2;

    const entities = { 'Oi dual': { msg: 'Dual Infodose ativa. Pulso enviado...' } };

    let training = '';
    let assistantEnabled = false;
    let conversation = [];
    let pages = [], currentPage = 0, autoAdvance = true;
    
    // Vari√°veis de configura√ß√£o
    let apiKey = localStorage.getItem('di_apiKey') || '';
    let modelName = localStorage.getItem('di_modelName') || 'meta-llama/llama-4-maverick:free';

    const createEl = (tag, cls, html) => {
      const e = document.createElement(tag);
      if (cls) e.className = cls;
      if (html) e.innerHTML = html;
      return e;
    };
    const splitBlocks = text => {
      let paras = text.split(/\n\s*\n/).filter(p=>p.trim());
      if (paras.length % 3 !== 0) {
        paras = paras.join(' ').match(/[^\.!\?]+[\.!\?]+/g).map(s=>s.trim());
      }
      const groups = [];
      for (let i=0; i<paras.length; i+=3) groups.push(paras.slice(i,i+3));
      return groups;
    };

    // ‚Äì‚Äì‚Äì Fala otimizada ‚Äì‚Äì‚Äì
    const speakText = (txt, onend) => {
      const u = new SpeechSynthesisUtterance(txt);
      u.lang = 'pt-BR';
      u.rate = 0.99;
      u.pitch = 1.1;
      u.volume = 1;
      if (window._vozes) u.voice = window._vozes.find(v=>v.lang==='pt-BR') || window._vozes[0];
      if (onend) u.onend = onend;
      speechSynthesis.speak(u);
    };

    const updateToggleUI = () => {
      document.getElementById('toggleBtn').classList.toggle('active', assistantEnabled);
    };

    // ‚Äì‚Äì‚Äì Carrega configura√ß√£o inicial ‚Äì‚Äì‚Äì
    function loadCfg() {
      const val = localStorage.getItem('infodoseEnabled');
      if (val === '1') {
        assistantEnabled = true;
        if (training) conversation.unshift({ role:'system', content: training });
      } else {
        assistantEnabled = false;
      }
      updateToggleUI();
    }

    const showLoading = msg => {
      const respEl = document.getElementById('response');
      const controls = respEl.querySelector('.response-controls');
      respEl.querySelectorAll('.page:not(.initial)').forEach(p=>p.remove());
      const page = createEl('div','page active');
      page.appendChild(createEl('p','footer-text',msg));
      respEl.insertBefore(page, controls);
      pages = [page];
      currentPage = 0;
      document.getElementById('pageIndicator').textContent = '‚Ä¶';
    };

    // ‚Äì‚Äì‚Äì Render + TTS paginado ‚Äì‚Äì‚Äì
    const renderPaginatedResponse = text => {
      speechSynthesis.cancel();
      autoAdvance = true;
      const respEl = document.getElementById('response');
      respEl.querySelectorAll('.page:not(.initial)').forEach(p=>p.remove());
      pages = [];
      const groups = splitBlocks(text);
      const controls = respEl.querySelector('.response-controls');
      const titles = ['üéÅ Recompensa Inicial','üëÅÔ∏è Explora√ß√£o e Curiosidade','‚ö° Antecipa√ß√£o Vibracional'];

      groups.forEach((tris, gi) => {
        const page = createEl('div', gi===0?'page active':'page');
        tris.forEach((body, j) => {
          const cls = j===0?'intro': j===1?'middle':'ending';
          const b = createEl('div','response-block '+cls,`
            <h3>${titles[j]}</h3><p>${body}</p>
          `);
          b.dataset.state = '';
          b.addEventListener('click', () => {
            if (!b.dataset.state) {
              speechSynthesis.cancel();
              speakText(body);
              b.classList.add('clicked');
              b.dataset.state = 'spoken';
            } else {
              b.classList.add('expanded');
              b.dataset.state = '';
              if (!assistantEnabled) {
                assistantEnabled = true;
                localStorage.setItem('infodoseEnabled','1');
                if (training) conversation.unshift({ role:'system', content: training });
                updateToggleUI();
              }
              const blockText = `${titles[j]}\n\n${body}`;
              showLoading('Pulso em Expans√£o...');
              speechSynthesis.cancel();
              speakText('Pulso em Expans√£o...');
              conversation.push({ role:'user', content: blockText });
              callAI();
            }
          });
          b.addEventListener('animationend', e => {
            if (e.animationName==='clickPulse') b.classList.remove('clicked');
          });
          page.appendChild(b);
        });
        page.appendChild(createEl('p','footer-text',
          `<em>Do seu jeito. <strong>Sempre</strong> √∫nico. <strong>Sempre</strong> seu.</em>`
        ));
        respEl.insertBefore(page, controls);
        pages.push(page);
      });

      currentPage = 0;
      document.getElementById('pageIndicator').textContent = `1 / ${pages.length}`;
      speakPage(0);
    };
    const speakPage = i => {
      const page = pages[i];
      const body = Array.from(page.querySelectorAll('.response-block p'))
        .map(p=>p.innerText).join(' ');
      speakText(body, () => {
        if (!autoAdvance) return;
        if (i < pages.length - 1) {
          changePage(1);
          speakPage(i+1);
        } else {
          speakText('Do seu jeito, sempre √∫nico, sempre seu.');
        }
      });
    };
    const changePage = offset => {
      const np = currentPage + offset;
      if (np<0||np>=pages.length) return;
      pages[currentPage].classList.remove('active');
      pages[np].classList.add('active');
      currentPage = np;
      document.getElementById('pageIndicator').textContent = `${currentPage+1} / ${pages.length}`;
    };

    // ‚Äì‚Äì‚Äì Chamada AI ‚Äì‚Äì‚Äì
    async function callAI() {
      if (!apiKey) {
        alert('Por favor, configure sua API Key no bot√£o de configura√ß√µes.');
        document.getElementById('settingsModal').classList.add('active');
        return;
      }

      const body = { model: modelName, messages: conversation, temperature: TEMPERATURE };
      try {
        const resp = await fetch(API_ENDPOINT, {
          method:'POST',
          headers:{
            'Authorization':`Bearer ${apiKey}`,
            'Content-Type':'application/json'
          },
          body: JSON.stringify(body)
        });
        
        if (!resp.ok) throw new Error('Erro API');

        const data = await resp.json();
        const answer = data.choices[0].message.content.trim();
        conversation.push({ role:'assistant', content: answer });
        renderPaginatedResponse(answer);
      } catch (err) {
        console.error(err);
        const errorMsg = 'O pulso oscilou (Erro de Conex√£o ou Key inv√°lida). Verifique as configura√ß√µes.';
        conversation.push({ role:'assistant', content: errorMsg });
        renderPaginatedResponse(errorMsg);
      }
    }

    // ‚Äì‚Äì‚Äì Envio de mensagem ‚Äì‚Äì‚Äì
    async function sendMessage(){
      const respEl = document.getElementById('response');
      const initPage = respEl.querySelector('.page.initial');
      if (initPage) initPage.remove();

      const input = document.getElementById('userInput');
      const raw = input.value.trim();
      if (!raw) return;
      input.value = '';

      speechSynthesis.cancel();
      speakText('');

      const txt = raw.toLowerCase();
      if (entities[txt]) {
        assistantEnabled = true;
        localStorage.setItem('infodoseEnabled','1');
        showLoading(entities[txt].msg);
        if (training) conversation.unshift({ role:'system', content: training });
        updateToggleUI();
      } else {
        showLoading('‚ö°Pulso enviado...Recebendo Inten√ß√£o‚Ä¶');
      }

      conversation.push({ role:'user', content: raw });
      callAI();
    }

    // ‚Äì‚Äì‚Äì Gerenciamento de Configura√ß√µes ‚Äì‚Äì‚Äì
    function setupSettings() {
      const modal = document.getElementById('settingsModal');
      const btn = document.getElementById('settingsBtn');
      const closeBtn = document.getElementById('cancelSettings');
      const saveBtn = document.getElementById('saveSettings');
      const keyInput = document.getElementById('apiKeyInput');
      const modelInput = document.getElementById('modelInput');

      btn.addEventListener('click', () => {
        keyInput.value = apiKey;
        modelInput.value = modelName;
        modal.classList.add('active');
      });

      const closeModal = () => modal.classList.remove('active');

      closeBtn.addEventListener('click', closeModal);

      saveBtn.addEventListener('click', () => {
        apiKey = keyInput.value.trim();
        modelName = modelInput.value.trim();
        localStorage.setItem('di_apiKey', apiKey);
        localStorage.setItem('di_modelName', modelName);
        alert('Conex√£o Neural Salva.');
        closeModal();
      });

      // Fecha se clicar fora
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      setupSettings();

      speechSynthesis.onvoiceschanged = () => {
        window._vozes = speechSynthesis.getVoices();
      };
      try {
        training = await fetch(TRAINING_FILE).then(r=>r.text());
      } catch {}
      loadCfg();

      particlesJS('particles-js',{
        particles:{ number:{value:40},color:{value:['#0ff','#f0f']},
        shape:{type:'circle'},opacity:{value:0.4},size:{value:2.4},
        move:{enable:true,speed:1.5} },retina_detect:true
      });

      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('userInput').addEventListener('keypress', e => {
        if (e.key==='Enter') sendMessage();
      });
      document.querySelector('[data-action="prev"]').addEventListener('click', () => changePage(-1));
      document.querySelector('[data-action="next"]').addEventListener('click', () => changePage(1));

      document.querySelector('.copy-button').addEventListener('click', () => {
        const pages = Array.from(document.querySelectorAll('.response-container .page'));
        const fullText = pages.map(p => p.innerText.trim()).join('\n\n');
        navigator.clipboard.writeText(fullText);
      });

      document.querySelector('.paste-button').addEventListener('click', async () => {
        try {
          const text = await navigator.clipboard.readText();
          document.getElementById('userInput').value = text;
        } catch (err) {
          console.error('Falha ao colar', err);
        }
      });

      document.getElementById('toggleBtn').addEventListener('click', () => {
        assistantEnabled = !assistantEnabled;
        if (!assistantEnabled) {
          alert('Infodose desativada');
          conversation = conversation.filter(m => m.role !== 'system');
          localStorage.setItem('infodoseEnabled','0');
        } else {
          if (training && !conversation.some(m => m.role==='system')) {
            conversation.unshift({ role:'system', content: training });
          }
          localStorage.setItem('infodoseEnabled','1');
        }
        updateToggleUI();
      });

      document.getElementById('voiceBtn').addEventListener('click', ()=>{
        const R = new (window.SpeechRecognition||window.webkitSpeechRecognition)();
        R.lang='pt-BR'; R.start();
        R.onresult = e => {
          document.getElementById('userInput').value = e.results[0][0].transcript;
          sendMessage();
        };
      });
    });
  </script>
</body>
</html>
